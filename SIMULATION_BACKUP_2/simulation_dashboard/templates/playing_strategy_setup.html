
{% extends 'layout.html' %}

{% block title %}Playing Strategy Setup{% endblock %}

{% block content %}
  <h1>Playing Strategy Setup</h1>

  <div class="setup-options">
    <button id="default-strategy">Use Default Strategy</button>
    <button id="saved-strategy">Load Saved Strategy</button>
    <button id="new-strategy">Create New Strategy</button>
  </div>

  <div id="strategy-details"></div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', () => {
    const newStrategyButton = document.getElementById('new-strategy');
    const savedStrategyButton = document.getElementById('saved-strategy');
    const defaultStrategyButton = document.getElementById('default-strategy');
    const strategyDetailsDiv = document.getElementById('strategy-details');

    newStrategyButton.addEventListener('click', () => {
        showCreateStrategyForm();
    });

    savedStrategyButton.addEventListener('click', () => {
        loadSavedStrategies();
    });

    defaultStrategyButton.addEventListener('click', () => {
        useDefaultStrategy();
    });

    function showCreateStrategyForm() {
        strategyDetailsDiv.innerHTML = `
            <h3>Create New Playing Strategy</h3>
            <div class="form-group">
                <label for="strategy-name">Name</label>
                <input type="text" id="strategy-name" required>
            </div>
            <div class="form-group">
                <label for="strategy-rules">Rules (JSON format)</label>
                <textarea id="strategy-rules" rows="10"></textarea>
            </div>
            <button id="save-strategy">Save Strategy</button>
        `;
        document.getElementById('save-strategy').addEventListener('click', saveNewStrategy);
    }

    function saveNewStrategy() {
        const name = document.getElementById('strategy-name').value;
        const rules = document.getElementById('strategy-rules').value;
        if (name) {
            fetch('/api/playing_strategies', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ name, strategy_type: rules ? 'custom' : 'default', rules }),
            })
            .then(response => response.json())
            .then(data => {
                if (data.id) {
                    alert('Playing strategy saved successfully!');
                    strategyDetailsDiv.innerHTML = '';
                } else {
                    alert('Error saving playing strategy.');
                }
            });
        }
    }

    function loadSavedStrategies() {
        fetch('/api/playing_strategies')
        .then(response => response.json())
        .then(strategies => {
            if (strategies.length > 0) {
                let strategyOptions = strategies.map(s => 
                    `<div class="strategy-option" data-strategy-id="${s.id}">${s.name}</div>`
                ).join('');
                strategyDetailsDiv.innerHTML = `
                    <h3>Select a Playing Strategy</h3>
                    ${strategyOptions}
                `;
                document.querySelectorAll('.strategy-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        const strategyId = e.target.dataset.strategyId;
                        fetch(`/api/playing_strategies/${strategyId}`)
                        .then(response => response.json())
                        .then(strategy => {
                            localStorage.setItem('selectedPlayingStrategy', JSON.stringify(strategy));
                            alert(`Playing strategy ${strategy.name} selected.`);
                            window.location.href = "/{{ url_for('index') }}";
                        });
                    });
                });
            } else {
                strategyDetailsDiv.innerHTML = '<p>No saved playing strategies found.</p>';
            }
        });
    }

    function useDefaultStrategy() {
        const defaultStrategy = { id: 0, name: 'Default Strategy', strategy_type: 'default', rules: null };
        localStorage.setItem('selectedPlayingStrategy', JSON.stringify(defaultStrategy));
        alert('Default playing strategy selected.');
        window.location.href = "/{{ url_for('index') }}";
    }
});
</script>
{% endblock %}
