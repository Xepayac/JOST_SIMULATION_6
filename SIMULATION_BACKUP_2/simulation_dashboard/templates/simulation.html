
{% extends 'layout.html' %}

{% block title %}Simulation Details{% endblock %}

{% block content %}
  <h1 id="simulation-name"></h1>
  <p><strong>Run on:</strong> <span id="simulation-timestamp"></span></p>

  <h2>Notes</h2>
  <ul id="notes-list"></ul>

  <h2>Add a New Note</h2>
  <textarea id="note-content" placeholder="Write your note here..."></textarea>
  <button id="save-note">Save Note</button>
  <p id="status-message"></p>
{% endblock %}

{% block scripts %}
  <script>
    const simulationId = {{ simulation_id }};
    const simName = document.getElementById('simulation-name');
    const simTimestamp = document.getElementById('simulation-timestamp');
    const notesList = document.getElementById('notes-list');
    const noteContent = document.getElementById('note-content');
    const saveNoteButton = document.getElementById('save-note');
    const statusMessage = document.getElementById('status-message');

    // Fetch Simulation Details
    fetch(`/api/simulations/${simulationId}`)
      .then(response => response.json())
      .then(simulation => {
        simName.textContent = simulation.name;
        simTimestamp.textContent = new Date(simulation.timestamp).toLocaleString();
      })
      .catch(error => console.error('Error fetching simulation details:', error));

    // Fetch and Display Notes
    function fetchNotes() {
        fetch(`/api/simulations/${simulationId}/notes`)
        .then(response => response.json())
        .then(notes => {
            notesList.innerHTML = ''; // Clear existing notes
            notes.forEach(note => {
            const listItem = document.createElement('li');
            listItem.textContent = `${note.content} - ${new Date(note.timestamp).toLocaleString()}`;
            notesList.appendChild(listItem);
            });
        })
        .catch(error => console.error('Error fetching notes:', error));
    }

    // Save a new note
    saveNoteButton.addEventListener('click', () => {
      const content = noteContent.value;
      if (!content) return;

      fetch(`/api/simulations/${simulationId}/notes`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ content: content }),
      })
      .then(response => response.json())
      .then(data => {
        if (data.id) {
          statusMessage.textContent = 'Note saved successfully!';
          noteContent.value = '';
          fetchNotes(); // Refresh the notes list
        } else {
          statusMessage.textContent = `Error: ${data.message}`;
        }
      })
      .catch(error => {
        console.error('Error:', error);
        statusMessage.textContent = 'An error occurred while saving the note.';
      });
    });

    // Initial fetch of notes
    fetchNotes();
  </script>
{% endblock %}
