{% extends "layout.html" %}

{% block title %}
Simulation Running
{% endblock %}

{% block content %}
<div class="container text-center">
    <h1 class="my-4">Simulation in Progress...</h1>
    
    <div id="status-container">
        <div class="spinner-border text-primary" role="status">
            <span class="sr-only">Loading...</span>
        </div>
        <p class="lead mt-3" id="status-text">The simulation is starting. Please wait.</p>
    </div>

    <div id="error-container" class="alert alert-danger mt-4" style="display: none;">
        <h4><i class="fas fa-exclamation-triangle"></i> Simulation Failed</h4>
        <p id="error-message"></p>
        <a href="{{ url_for('main.run_simulation_page', simulation_id=simulation.id) }}" class="btn btn-primary">Return to Setup</a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const statusText = document.getElementById('status-text');
        const errorContainer = document.getElementById('error-container');
        const errorMessage = document.getElementById('error-message');
        const statusContainer = document.getElementById('status-container');

        const taskId = "{{ simulation.task_id }}";
        const checkStatusUrl = `/task_status/${taskId}`;

        function checkStatus() {
            fetch(checkStatusUrl)
                .then(response => response.json())
                .then(data => {
                    statusText.textContent = data.status || 'Checking...';

                    if (data.state === 'SUCCESS') {
                        statusText.textContent = "Simulation complete! Redirecting to results...";
                        window.location.href = data.result_url;
                    } else if (data.state === 'FAILURE') {
                        statusContainer.style.display = 'none'; // Hide spinner
                        errorMessage.textContent = data.status;
                        errorContainer.style.display = 'block'; // Show error
                    } else {
                        // If still running, check again after a delay
                        setTimeout(checkStatus, 3000); // Poll every 3 seconds
                    }
                })
                .catch(err => {
                    console.error("Error checking task status:", err);
                    statusContainer.style.display = 'none'; 
                    errorMessage.textContent = "Could not connect to the server to check the simulation status.";
                    errorContainer.style.display = 'block';
                });
        }

        // Start checking the status
        checkStatus();
    });
</script>
{% endblock %}
